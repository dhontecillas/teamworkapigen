#!/bin/bash

# check that there all actual changes to apply
if [[ -z "$V1SWAGGER" && -z "$V2SWAGGER" && -z "$V3SWAGGER" && -z "$PMSWAGGER" ]]
then
    echo "No openapi spec to update"
    exit 0
fi

# export TMPDIR="TMP_PR_${HOME}/$(date +%Y%m%d_%H%m%S)"
export CURDATE=$(date +%Y%m%d_%H%m%S)
export CURDIR=$(pwd)
export TMPDIR="$HOME/data/TMP_PR_$CURDATE"

mkdir -p $TMPDIR

git config --global user.email $GITHUB_USER_EMAIL
git config --global user.name $GITHUB_USER_NAME

if [ -z "$GITHUB_NEW_BRANCH" ]
then
    export GITHUB_NEW_BRANCH="update/swagger_$CURDATE"
fi

# echo $GITHUB_TOKEN | gh login --with-token
cd $TMPDIR
git clone https://${GITHUB_TOKEN}@github.com/dhontecillas/teamworkapigen.git $TMPDIR

# checkout branch or create a new branc with the name
git checkout $GITHUB_NEW_BRANCH || git checkout -b $GITHUB_NEW_BRANCH

NEEDS_UPDATE="0"

if [ -z "$V3SWAGGER" ]
then
    echo "NO V3 update"
else
    diff $V3SWAGGER ./openapi_specs/projectsapigo.v3.yaml
    if [ "$?" -gt "0" ]; then
        echo "cp $V3SWAGGER ./openapi_specs/projectsapigo.v3.yaml"
        cp $V3SWAGGER ./openapi_specs/projectsapigo.v3.yaml
        git add ./openapi_specs/projectsapigo.v3.yaml
        git commit -m 'add updated v3 openapi spec'
        git push -u origin $GITHUB_NEW_BRANCH
        NEEDS_UPDATE="1"
    fi
fi

if [ -z "$V2SWAGGER" ]
then
    echo "NO V2 update"
else
    diff $V2SWAGGER ./openapi_specs/projectsapigo.v2.yaml
    if [ "$?" -gt "0" ]; then
        echo "cp $V2SWAGGER ./openapi_specs/projectsapigo.v2.yaml"
        cp $V2SWAGGER ./openapi_specs/projectsapigo.v2.yaml
        git add ./openapi_specs/projectsapigo.v2.yaml
        git commit -m 'add updated v3 openapi spec'
        git push -u origin $GITHUB_NEW_BRANCH
        NEEDS_UPDATE="1"
    fi
fi

if [ -z "$V1SWAGGER" ]
then
    echo "NO V1 update"
else
    diff $V1SWAGGER ./openapi_specs/projectsapigo.v1.yaml
    if [ "$?" -gt "0" ]; then
        echo "cp $V1SWAGGER ./openapi_specs/projectsapigo.v1.yaml"
        cp $V1SWAGGER ./openapi_specs/projectsapigo.v1.yaml
        git add ./openapi_specs/projectsapigo.v1.yaml
        git commit -m 'add updated v2 openapi spec'
        git push -u origin $GITHUB_NEW_BRANCH
        NEEDS_UPDATE="1"
    fi
fi

if [ -z "$PMSWAGGER" ]
then
    echo "NO PM update"
else
    diff $PMSWAGGER ./openapi_specs/projectsapigo.pm.yaml
    if [ "$?" -gt "0" ]; then
        echo "cp $PMSWAGGER ./openapi_specs/projectsapigo.pm.yaml"
        cp $PMSWAGGER ./openapi_specs/projectsapigo.pm.yaml
        git add ./openapi_specs/projectsapigo.pm.yaml
        git commit -m 'add updated pm openapi spec'
        git push -u origin $GITHUB_NEW_BRANCH
        NEEDS_UPDATE="1"
    fi
fi

if [ "$NEEDS_UPDATE" -ge "1" ]; then
    gh pr create --base main --head $GITHUB_NEW_BRANCH \
        --title "Update OpenAPI Spec $GITHUB_NEW_BRANCH" \
        --body "Update OpenAPI Spec $GITHUB_NEW_BRANC"
else
    echo "OpenAPI Spec files have no differences"
fi

cd $CURDIR
rm -rf $TMPDIR
